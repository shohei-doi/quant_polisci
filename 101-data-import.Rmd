# データの読み込み {#data-import}

統計分析をする際にはデータを読み込む（インポート）必要があります。
基本的にPCに保存されたデータのパスを入力することでデータを読み込みます。

-　URLを入力することでオンラインのデータを読み込むこともできます。

ここでは、まずRやパッケージに付属のデータセットの読み込み方を解説し、統計分析でよく使われるデータ形式を紹介した後に、Rによる読み込み方を説明します。

```{r}
library(tidyverse)
```

```{r, echo=FALSE}
library(knitr)
```

## パッケージ付属のデータ

Rは標準でいくつかのデータセットを持っており、またパッケージを読み込むと付属のデータセットも読み込みます。
`data()`に何も入力せずに実行すると、データセットの一覧が表示されます。

```{r}
data()
```

よく、使われるデータセットはフィッシャーのアヤメのデータセットで、`iris`という名前で保存されています。

```{r}
head(iris)
```

- `head()`は最初のいくつかの要素だけを表示する関数です（`tail()`は最後からいくつかを表示します）。

## 主なデータ形式*

大雑把に言ってしまうとPCのデータにはテキストデータとバイナリデータに分かれます。
さらにそれぞれ様々な種類の形式がありますが、拡張子によって判断します。

### テキストデータ

テキストデータとは人間の理解できる文字列のデータのことです。

#### .txtファイル

`.txt`ファイルは素のテキストデータになり、データの構造を含みません。
統計分析をする際には使いませんが、テキスト分析をする場合はしばしば遭遇します。

#### .csvファイル

統計分析で遭遇するテキストデータの大半は`.csv`ファイルです。
これは"comma-separated values"の略で、各変数はカンマで区切られています。
各観察は改行で区切られています。

#### .tsvファイル

`.tsv`ファイルはカンマの代わりにタブで変数が区切られているテキストデータになります。

#### .htmlファイル

`.html`ファイルとはウェブサイトの内容を記述してあるファイルです。
ウェブスクレイピング（PCに自動でオンラインの情報を収集させること）をする際に使います。

### バイナリデータ

バイナリデータとはPCは理解できるけど人間は特定のソフトを使わないと理解できないようなデータになっています。

#### .xls, .xlsxファイル

最も有名なのはExcelで使用される`.xls`または`.xlsx`ファイルでしょう。

- `.xlsx`の方が`.xls`よりも新しくて高圧縮らしいです。

#### .dtaファイル

`.dta`ファイルとはStataと呼ばれる統計分析ソフト専用のデータ形式になります。
Stataは政治学や経済学で人気のツールなのでレプリケーションデータなどはこの形式で配布されていることもあります。

#### .savファイル

`.sav`ファイルはStataよりも前に人気だった統計ソフト用のデータ形式です。

#### .rdsファイル

`.rds`ファイルとはR戦争のデータ形式になります。
あまり見かけることはありません。

### Good bye, Excel!

基本的にはRでデータを読み込めば中身を見ることができるのですが、後述するようにRで読み込む前に生データを見たい場合はしばしばあります。

そのときにMicrosoft OfficeのExcelを使うのはあまりおすすめしません。
なぜなら、

- Officeは高い
- 文字エンコードを指定できない

からです。

特に後者の問題は重要だと思います。
例えば日本語を含むデータの場合、Windowsで作成されたものをLinuxやMacで開くと、あるいはその逆をすると文字化けを起こすからです。

そこで、[LibreOffice](https://ja.libreoffice.org/)という無料のオフィスソフトをダウンロードし、その中のCalcを使用することをおすすめします。
LibreOffice Calcであればファイルを開く際にエンコードを選択できるので文字化けすることはありません。

- Windowsで文字けする場合、エンコードを`UTF-8`にする。
- Linux, Macで文字化けする場合、エンコードを`Shift-JIS`あるいは`CP932`にする。
  - もちろん、LibreOfficeでMicrosoft Officeのデータを開くことは可能です。
  - ただし、LibreOfficをインストールするとMicrosoft Officeが正常に動作しないことがあるかもしれません。
  
## パスと作業ディレクトリ

一般的に、PCのデータは**ファイル**と呼ばれ、ファイルを入れておく箱のようなものを**フォルダ**（ディレクトリ）と呼びます。

例えば、Windowsの場合、documentsやpicturesというフォルダがあり、その中にWordファイルや画像データが入っていると思います。

なお、ファイルの名前の末尾には`.`から始まる**拡張子**がついています。
例えば、Wordファイルであれば`.docx`、画像データであれば`.png`や`.jpg`などです。
これはそのファイルがどのような種類のもので、PCがどのように処理をすればいいのかを示す目印になっています。

-　もし、PCで拡張子が表示されていない場合は表示するように設定しましょう。

### パス

ファイルやフォルダにアクセスする場合、**パス**と呼ばれるPC上の住所のようなもので指定する必要があります。

例えば、Windowsの場合、documentsフォルダの中の`sample.docx`というファイルのパスは`C:/Users/Shohei/Documents/sample.docx`となります。

- 正確には、Windowsでは`/`ではなく円マークになっていると思います。

#### 絶対パス

このパスの意味はCドライブの中の`User`というフォルダの中の`Shohei`というフォルダの中の`Documents`というフォルダの中にある`sample.docx`という意味です。

このように始点（Windowsの場合はCドライブ）から始めるパスを**絶対パス**と呼びます。

#### 相対パス

しかし、毎回、絶対パスを書くのは面倒ですし、コードを公開する際にはやや恥ずかしい嫌いもあります。

そこで、途中から書かれるパスを**相対パス**と呼びます。
例えば、`Shohei`というフォルダから見れば、上記のファイルは`Documents/sample.docx`として指定することができます。

#### パスに関する注意点

必ずしも直ちに問題があるわけではないですが、パスに日本語や空白があるとうまく行かないことがあります。
なので、フォルダ名やファイル名はアルファベットで空白を入れない方がいいでしょう。

- もしユーザー名が日本語である場合、パス関連でエラーが出る場合は[RStudio Cloud](https://rstudio.cloud/)を使うか、これを機にOSをクリーンインストールをしてしまうのもありでしょう。

### 作業ディレクトリ

相対パスでファイルなどを指定する際には出発点となるフォルダを決める必要があります。
これを**作業ディレクトリ**と呼びます。

Rでは`getwd()`（"get working directory"の略）で現在の作業ディレクトリを確認できます。

また、`setwd()`に適当なパスを入力することで作業ディレクトリを設定することもできます。

RStudioの場合は`Files`パネルの中の`More > Set As Working Directory`で現在開いているフォルダを作業ディレクトリに指定することもできます。

```{r, echo=FALSE}
include_graphics("figures/workflow1.jpg")
```

ただし、作業ディレクトリを指定するよりも、**[Rプロジェクト]を作成するのがベター**です。

## .csvファイルの読み込み

ここでは、例として世界銀行の[各国の一人あたりGDPデータ](data/wb_gdp_pc.csv)を読み込んでみます。
今回は適当に作成したプロジェクト・フォルダの中に`data`というフォルダを作成し、その中に`wb_gdp_pc.csv`というデータを保存してください。

ここでは、`tidyverse`の中の`readr`の`read_csv()`という関数を使います。

- Rの標準関数は`read.csv()`です（`_`と`.`が違います）。

```{r}
gdp_pc <- read_csv("data/wb_gdp_pc.csv")
```

データを読み込む際には`()`の中に読み込みたいデータのパスを入力する必要があります。
したがって、プロジェクト・フォルダから見たデータの相対パスは`data/wb_gdp_pc.csv`となります。

- パスをクオーテーションマーク`"`で囲むことを忘れないでください。
- パスの頭に`/`はいりません。
- パスの最後に拡張子を付けることを忘れすに。

読み込んだデータもオブジェクトなので適当な名前をつけて代入する必要があります。
データの名前は

- 打ち込むのがめんどくさくない程度に短く
- 他人や数カ月後の自分が見ても分かる程度には意味の分かる

ようにするのがコツです。

さて、データを無事読み込めると`Environment`パネルに`gdp_pc`が表示されていると思います。

### 変数名の適切な読み込み

これで一安心と思いきや、`Warning`という不吉な文字列が見えます。
`Environment`パネルをよく見ると変数の数が3つしかないということがわかります。
そこで、データを見てみると、なにかおかしいことが起こっているようです。

- `Warning`とは`Error`のように実行できないほどではないけれど、なんか問題があるかもしれない場合に表示されます。
- **`Warning`が出たときは問題がないのか確認しましょう。**

```{r}
head(gdp_pc)
```

このような場合はLibreOffice Calcで元データを見てみましょう。

```{r, echo=FALSE}
include_graphics("figures/data_import1.jpg")
```

実は`read_csv()`ではデフォルトでは第1行目を変数名として読み込む設定になっています。
なので、元データの`Data Source`と`World Development Indicators`を変数名として認識してしまったようです。

- では、なぜ三番目も変数として認識されているのかはよく分かりません。

変数名は第5行目なので、単純な方法は第1行目から第4行目を削除してしまうことですが、そうすべきではない理由がいくつかあります。

1. 新しい年のデータを使うときに同じ操作をしないといけない。
1. 同じ形式のデータを使うときに同じ操作をしないといけない。
1. 第三者が元データからレプリケートするときに気付かないかもしれない。

ということで、第5行目からデータとして読み込めないか確かめるためにヘルプを見ます。

```{r}
?read_csv
```

すると、このような記述が見つかります。

```{}
skip    Number of lines to skip before reading data.
```

ということで、オプションとして`skip=4`を設定して読み込むとうまく行きました

```{r}
gdp_pc <- read_csv("data/wb_gdp_pc.csv", skip=4)
```

```{r}
head(gdp_pc)
```

- ちなみに`NA`とはRにおける欠損値 (missing value) のことです。

なお、実はこのように時間（この場合は年）が横方向に進んでいくデータをワイド形式と呼び、大抵の場合はこのままでは分析できないのでロング形式にする必要があります。

## .xls[x]ファイルの読み込み

実は`tidyverse`はいくつかのパッケージをまとめたものになっています。
これまでテキストデータの読み込みに使っていたのは、その中の`readr`というパッケージになります。

バイナリデータを読み込むには別途パッケージを使う必要があり、`.xls[x]`ファイルの場合は以下のものになります。

```{r}
library(readxl)
```

`.xls`か`.xslx`か分かっている場合は`read_xls()`もしくは`read_xlsx()`の適切な方を使い、分からない場合は`read_excel()`を使います。
ここでは[Freedom Houseのデータセット](data/FH_Country.xls)を読み込みます。

```{r}
fh <- read_excel("data/FH_Country.xls")
```

### シートの選択

`Environment`パネルに`fh`があるので一安心と思いきや、変数の数が1つと明らかにおかしいので、Rでデータを見て、LibreOffice Calcで開いてみます。

```{r}
head(fh)
```

```{r, echo=FALSE}
include_graphics("figures/data_import2.jpg")
```

すると、全くデータが異なっていることがわかります。
実はエクセルのデータにはシートという概念があり、異なるデータを一つにまとめることができます。

LibreOffice Calcの左下をよく見ると二番目のシートが選択されていることがわかります。
そしてその左の一番目のシートを選択するとRで読み込まれたものと同じものがあることがわかります。

つまり、先程は自動で一番目のシートを読み込んでしまっていたということで、オプションで二番目のシートを読み込まないといけないわけでした。
そこでヘルプを見ると`sheet`というオプションがあるので、`sheet=2`とするとちゃんとほしいデータを読み込んでくれます。

```{r}
fh <- read_excel("data/FH_Country.xls", sheet=2)
head(fh)
```

### 変数名の適切な読み込み (again)

これで一安心かと思いきや、そうではありません。
よくみると変数名が適切に選択されていないので、先ほどと同様に`skip`を設定する必要があります。

```{r}
fh <- read_excel("data/FH_Country.xls", sheet=2, skip=2)
head(fh)
```

### 欠損値の処理

残念ながら問題はまだ残っています。
`head()`でデータの冒頭を見たときに変数名の下に`<chr>`とあるのに注目してください。
これは、当該変数が文字列 (character) であることを意味しています。

国名やステータスが文字列なのは当然として、本来数値データのはずの`PR` (political rights) や`CL` (civil liberty) も文字列データになっています。
元データを見てみると、ところどころ`-`という記号が含まれていることがわかります。

実はこれはFreedom Houseのデータセットにおける欠損値なのですが、Rではデフォルトでは空欄を欠損値として認識します。
そこで、やはりヘルプを見て`na`を設定して`-`も欠損値として読み込むようにします。

```{r}
fh <- read_excel("data/FH_Country.xls", sheet=2, skip=2, na="-")
head(fh)
```

実は文字列のままの`PR`や`CL`もあるのですが、そこはややこしいので今回は見なかったことにします。

## .dtaファイルの読み込み

`.xls[x]`ファイルと同様`.dta`ファイルもバイナリデータなので専用のパッケージを読み込みます。

```{r}
library(haven)
```

ここでは、Bruce Russett and John R. Oneal (2001) "Triangulating Peace" の[レプリケーションデータ](data/TRIANGLE.DTA)（とされるもの）を読み込みます。

```{r}
triangle <- read_dta("data/TRIANGLE.DTA")
head(triangle)
```

ハッピーなことにStataのデータはそもそも統計分析用に加工されているので、特に面倒くさい手続きをする必要はありません。

## .rdsファイルの読み込み

R専用のバイナリデータの形式は`.rds`なので、`write_rds()`で書き出し、`read_rds()`で読み込むことができます。

## パス入力の省略*

データを読み込む際にいちいちパスを打ち込むのは面倒です。
そこで、右下の`Files`パネルで読み込みたいデータをクリックすると`Import Dataset...`というのがあるのでクリックします。

```{r, echo=FALSE}
include_graphics("figures/data_import3.jpg")
```

すると次のような画面が出てきますが、右下にデータを読み込むためのパッケージ、関数、パスが表示されるので、関数とパスの部分をコピペしてしまうと楽です。

```{r, echo=FALSE}
include_graphics("figures/data_import4.jpg")
```

オブジェクト名の部分は自動的に決まるので、もとのデータの名前が長いとオブジェクト名も長くなり、かっこよくないので**自分で設定する**ようにしたほうがよいでしょう。

また、データのプレビューも可能なのでここで`skip`などの設定をすることも可能です。

## データの書き出し

データを書き出す際には、基本的に`.csv`ファイルでよいと思うので、`write_excel_csv()`に保存したいオブジェクト名とパスを入れておきましょう。
ここでは試しにTriangulating Peaceのデータを保存してみます。

```{r}
write_excel_csv(triangle, "data/triangle.csv")
```

指定したパスに新しくファイルができていることを確認してください。

Triangulating Peaceデータの`.csv`ファイルと`.dta`ファイルの容量を見ると`.dta`ファイルのほうが小さいことがわかります。
この程度では問題ありませんがデータがあまりにも大きくなる場合はバイナリデータで保存したほうがよいでしょう。