# Rプログラミング入門 {#intro-r}

## 関数

**関数** (function) とは何かを入力すると、何かを出力するものです。
例えば、

```{r}
print("Hello, World.")
```

というコードは、`"Hello, World."`という文字列を`print()`という関数に入力し、その文字列を出力しています。

- Rでは、関数は`関数名()`という形を取ります。
- 入力するものを入力引数 (input argument) 、出力するものを出力引数 (output argument) と呼んだりします。

次のように、入力引数も出力引数も1つとは限りません。

```{r}
rnorm(n = 10, mean = 0, sd = 1)
```

さて、この関数は何をしているのでしょうか。
Rでは、関数名の前に`?`をつけて実行することで、その関数のヘルプを見ることができます。

```{r}
?rnorm
```

英語で関数の使い方が解説されていますが、`rnorm(n = 10, mean = 0, sd = 1)`は平均0、標準偏差1の（標準）正規分布に従う乱数を10個だけ生じさせています。

入力引数は`=`で明示的に指定する場合、どのような順番でも構いません。

```{r, eval=FALSE}
rnorm(mean = 0, sd = 1, n = 10)
```

入力引数を明示的に指定しない場合、ヘルプにある順番で入力します。
以下の例は上述のものと同じです。

```{r, eval=FALSE}
rnorm(10, 0, 1)
```

また、ヘルプで`mean = 0, sd = 1`のように書かれている場合、デフォルトが定められています。
実行者が入力引数を指定しない限り、デフォルト値が使用されます。
したがって、以下の例もこれまでと同じコードです。
ｘ
```{r, eval=FALSE}
rnorm(10)
```

## オブジェクト

Rでは`<-`でオブジェクトを作成することができます。
例えば、100個の正規分布に従う乱数を`x`という名前のオブジェクトとして作成します。

```{r}
x <- rnorm(100)
```

- RStudioでは`<-`はショートカット`Alt + -`で入力できます。

```{r}
x
```

実際に、乱数が`x`に格納されていることが分かります。

オブジェクトを入力引数とすることも可能です。
`x`の平均と標準偏差を求めてみます。

```{r}
mean(x)
sd(x)
```

もちろん、出力引数を新しいオブジェクトにすることもできます。

```{r}
x.mean <- mean(x)
x.mean
```

- オブジェクトの名前にはアルファベットと数字、`.`と`_`が使えます。
- ただし、数字は最初の文字としては使えません。

オブジェクトは上書きすることもできます。

```{r}
x.mean <- mean(rnorm(100))
```

## パッケージ

大雑把に言って、Rによるデータ分析は**データをオブジェクトとして読み込み、いろいろな関数で処理を行うこと**で実行します。

つまり、関数が重要なのですが、Rで標準に備わっている関数には限界があります。
そこで、様々な研究者が関数を作成し、それをまとめたものを**パッケージ**として公開しています。

- 基本的に、[CRAM](https://cran.r-project.org/)でパッケージは公開されます。

パッケージをインストールするには、`install.packages()`という関数にパッケージ名を入れて実行します。
試しに、[Tidyverse](https://www.tidyverse.org/)という幅広く使われているパッケージをインストールしてみます。

```{r, eval=FALSE}
install.packages("tidyverse")
```

- RStudioの場合、`Packages`パネル（デフォルトの場合は右下）の中に`Install`というボタンがあり、そこにパッケージ名を入力していインストールすることも可能です。

`"`でパッケージ名を囲まないとエラーになります。

```{r, error=TRUE}
install.packages(tidyverse)
```


インストールしたパッケージに対して再び`install.packages()`を行うと、最新版にアップデートされます。

- RStudioの場合、`Packages`パネルに`Update`というボタンがあり、アップデートできるパッケージを自動検索してくれます。

パッケージはインストールしただけでは使用することはできず、`library()`で読み込む必要があります。

```{r}
library(tidyverse)
```

- この場合は`"`で囲む必要はありません。
- インストールは一回で十分です。

RStudioであれば`Packages`パネルにインストール済みのパッケージ一覧があるので、パッケージ名をクリックすると含まれる関数一覧を見ることができます。

- 同様のものは[CRAM](https://cran.r-project.org/)でも`pdf`形式で見ることができます。
- 一部のソフトウェアは[Journal of Statistical Software](https://www.jstatsoft.org/index)などで論文が公開されています。

### Tidyverseとは

## Rスクリプト

## Rプロジェクト

## 関数の作成

Rで関数を自作する際は`function(){}`という関数を使います。

- `()`の中に入力引数を記述します。
- `{}`の中に処理内容を記述し、最後に`return()`で出力引数を指定します。

例えば、数値ベクトルを入力引数として、平均と標準偏差を出力引数とする関数を作成します。

```{r}
mean_sd <- function(x) { # 入力引数の名前をxとしておきます。
  mean.x <- mean(x) # 平均を計算します。
  sd.x <- sd(x) # 標準偏差を計算します。
  return(c(mean.x, sd.x)) # 出力引数を指定します。
}
```

実際に実行してみます。

```{r}
x <- rnorm(100)
mean_sd(x)
```

## ループ

**ループ**とは同一の処理を複数回実行することを指します。
例えば、100個の標準正規分布に従う乱数の平均を5回求める処理は次のようになります。

```{r}
for (i in 1:5) {
  print(mean(rnorm(100)))
}
```

`for`ループとは`()`の中の`in`のあとのベクトルの第1要素から順番に`i`に代入して繰り返しています。
そのことは、次の例から解ると思います。

```{r}
head(letters)
```

- `letters`とはアルファベットのベクトルです。

```{r}
for (i in head(letters)) {
  print(i)
}
```

- `for`ループとは別に、特定の条件が満たされるまで繰り返される`while`ループもあります。

ループ処理の結果を格納するには少しテクニックが必要です。
100個の乱数の平均を5回取ったものを`x`として保存したいとします。

まず、`x`を`NULL`オブジェクトとして作成します。

```{r}
x <- NULL
x
```

- `NULL`とは空っぽのオブジェクト（0という数値や空白という文字ではない）です。

先程のループ処理の中で、計算した平均を`c()`で`x`にくっつけていきます。

```{r}
for (i in 1:5) {
  x <- c(x, mean(rnorm(100)))
}
x
```

無事、5個の平均値が`x`に保存されていることがわかります。

実際に`for`ループの中で何が起こっているかは、次のコードで解ると思います。

```{r}
x <- NULL
for (i in 1:5) {
  x <- c(x, mean(rnorm(100)))
  print(x)
}
```

- ループが一周するたびに、前回の`x`に新しい要素が付け加わり、新しい`x`として保存されています。

`NULL`オブジェクトを使ったループ結果の保存でよくあるミスは、やり直す際に`NULL`でリセットするのを忘れることです。
例えば、同じコードをもう一度実行しましょう。

```{r}
for (i in 1:5) {
  x <- c(x, mean(rnorm(100)))
}
x
```

- `x`に10個の平均値が入っています。

このようなミスを避ける方法の一つは、全体を関数として作成することです。

```{r}
multi_mean <- function() {
  x <- NULL
  for (i in 1:5) {
    x <- c(x, mean(rnorm(100)))
  }
  return(x)
}
x <- multi_mean()
x
```

## 条件分岐

**条件分岐**とは、特定の条件の場合に特定の動作を行うようにすることです。
例えば、正の場合`positive`、負の場合`negative`と出力するコマンドは次のようになります。

```{r}
x <- rnorm(1)
if (x > 0) {
  print("positive")
} else {
  print("negative")
}
print(x)
```

- `if(){}`の`()`の中に条件式を書き、`{}`の中に処理内容を書きます。
- それ以外の条件は`else`で示します。

条件式は3つ以上でも構いません。

```{r}
x <- rnorm(1)
if (x > -0.5) {
  print("x is less than -0.5.")
} else if (x >= -0.5 & x <= 0.5) {
  print("x is between -0.5 and 0.5.")
} else {
  print("x is more than 0.5.ー")
}
print(x)
```

- `&`は「かつ」を意味します。
- 「または」は`|`を使います。
- `>=`は $\geq$ を意味します。
- 「同じ値である」は`==`を使います（`=`ではない点に注意）。

## 練習問題：フィボナッチ数列

フィボナッチ数列とは以下の条件を満たす数列です。

$$
\begin{aligned}
  F_0 &= 0 \\
  F_1 &= 1 \\
  F_{n} &= F_{n-1} + F_{n-2} \quad n \geq 2
\end{aligned}
$$

例えば、

$$
\begin{aligned}
  F_2 = 1, F_3 = 2, F_4 = 3, F_5 = 5, F_6 = 8,\ldots
\end{aligned}
$$

となります。

フィボナッチ数列の第$n$項を（解析解を使わずに）求める関数を作成してみて下さい。

## 練習問題：モンテカルロ・シミュレーション

モンテカルロ・シミュレーション（モンテカルロ法）とは乱数を用いて近似解を求める手法です。

例えば、円周率$\pi$の近似解は以下のように求めることができます。

1. 0以上1未満の一様分布から$n$個の乱数$x_i$と$n$個の乱数$y_i$を発生させます ($i = 1,2,\ldots,n$) 。
1. 原点と$(x_i,y_i)$の距離が1以下である回数を計算し$n_1$とします。
1. 円周率の近似解として$\hat{\pi} = 4 \times n_1/n$を得ます。

モンテカルロ・シミュレーションによる円周率の近似解を求める関数を作成してみて下さい。

また、モンテカルロ・シミュレーションによる円周率の近似解を$m$回求めて、その平均値や標準偏差が$n$によってどのように変化するか検討してみて下さい。